<!-- views/index.ejs -->
<!doctype html>
<html>
<head>
    <% include partials/head %>
</head>
<body>
  <header>
    <% include partials/header %>
    <style media="screen">
      #map { height: 100% }
    </style>

  </header>
  <main>
    <div class="container">
      <h3>Nombre Empresa</h3>
      <!-- Opciones de Filtro -->
      <div class="panel panel-default">
        Seleccionar Unidad : <select class="" name=""><option/> </select> <button type="iniciar" name="iniciar" onclick="iniciarMovimiento()">Iniciar Movimiento</button>
      </div>
      <!-- MAPA-->
      <div class="panel panel-default" style="height:700px">
        <div id="map">

        </div>

      </div>

    </div>
  </main>
  <footer>
    <% include partials/footer %>
  </footer>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCfaLOJAefzXT75bIWgxd8RmcWz5rWbMec&signed_in=true">
  </script>

  <script type="text/javascript">
  var map;
  var marker;
  var movPos = {lat:-7.161709, lng:-78.509672};

  var movPos2 = {lat:-7.161709, lng:-78.509672};

  map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: -7.16, lng: -78.51},
      zoom: 14
    });

// capa de trafico
var transitLayer = new google.maps.TransitLayer();
transitLayer.setMap(map);


    var infoWindow = new google.maps.InfoWindow({map: map});


    // Try HTML5 geolocation.
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        infoWindow.setPosition(pos);
        infoWindow.setContent('Location found.');
        map.setCenter(pos);

      }, function() {
        handleLocationError(true, infoWindow, map.getCenter());
      });
    } else {
      // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
    }

// marcadores
marker = new google.maps.Marker({
    position: movPos,
    map: map,
    title: 'Marcador simple!'
  });
marker2 = new google.maps.Marker({
  position:movPos2,
  map:map,
  title:'Marcador 2'
});


function redraw(){
  map.setCenter({lat: movPos.lat, lng : movPos.lng, alt: 0})
  marker.setPosition(movPos);
  marker2.setPosition(movPos2);
}

//bucle recursivo para asegurar que funcione el setTimeout
//var i = 0, n = 100;
function iniciarMovimiento() {
    movPos.lat += 0.01;
    movPos.lng +=0.01;

    movPos2.lat += 0.01;

  //  alert(movPos.lat.toString() +" "+ movPos.lng.toString());
    redraw();

    //i++;
  //  if( i < n ){
        setTimeout(iniciarMovimiento, 1000 );
  //  }
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.' :
                      'Error: Your browser doesn\'t support geolocation.');
}
  </script>



</body>
</html>
